"use strict";(()=>{var a={};a.id=714,a.ids=[714],a.modules={261:a=>{a.exports=require("next/dist/shared/lib/router/utils/app-paths")},846:a=>{a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},2284:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{OPTIONS:()=>j,POST:()=>i});var e=c(5592),f=c(6227),g=c(4808),h=a([f]);f=(h.then?(await h)():h)[0];let k=new g.n;async function i(a){try{let b={};a.headers.forEach((a,c)=>{b[c]=a}),console.error("\uD83D\uDCCB Get-Slots API - All headers:",JSON.stringify(b)),console.error("\uD83D\uDCCB Get-Slots API - X-API-Key header:",a.headers.get("x-api-key")||a.headers.get("X-API-Key")||"NOT FOUND"),console.log("\uD83D\uDD0D Get-Slots API Debug - Request received");let c=await k.secureRequest(a,{requireAuth:!0,rateLimit:{maxRequests:50,windowMs:9e5},inputSchema:g.U.scrapeRequest,allowedMethods:["POST"]});if(!c.allowed)return console.error("‚ùå Security check failed:",c.response),k.addSecurityHeaders(c.response);let d=c.sanitizedData;console.log(`‚úÖ Parsed and validated data:`,d);let h=Date.now(),i=a.headers.get("x-forwarded-for")||a.headers.get("x-real-ip")||"unknown",j=a.headers.get("user-agent")||"unknown",l=d.days?parseInt(d.days.toString(),10):void 0;if(l&&(l<1||l>30))return e.NextResponse.json({success:!1,error:"Validation Error",message:"days parameter must be between 1 and 30"},{status:400});console.log("\uD83D\uDD0D Starting scraping process..."),l&&console.log(`üìÖ Requested ${l} days`);let m=new f.o,n=await m.scrapeSlots(d.first_name,d.last_name,d.email,d.phone,void 0,l);if(!n.success){console.log(`‚ùå Scraping failed: ${n.error}`);let a=Date.now()-h;k.logSecurityEvent("SCRAPING_FAILED",{endpoint:"/api/get-slots",userAgent:j,responseTime:a,error:n.error},i);let b=e.NextResponse.json({success:!1,error:"Scraping failed",message:n.error},{status:500});return k.addSecurityHeaders(b)}console.log("‚úÖ Scraping completed successfully"),console.log(`üìä Result: ${n.data?.total_days} days, ${n.data?.total_slots} slots`);let o=Date.now()-h;k.logSecurityEvent("SCRAPING_SUCCESS",{endpoint:"/api/get-slots",userAgent:j,responseTime:o,daysFound:n.data?.total_days,slotsFound:n.data?.total_slots},i);let p=e.NextResponse.json(n);return k.addSecurityHeaders(p)}catch(b){console.error("‚ùå API error:",b);let a=e.NextResponse.json({success:!1,error:"Internal Server Error",message:"An unexpected error occurred"},{status:500});return k.addSecurityHeaders(a)}}async function j(a){let b=new e.NextResponse(null,{status:200});return k.configureCORS(b)}d()}catch(a){d(a)}})},3033:a=>{a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3237:a=>{a.exports=import("playwright")},3295:a=>{a.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},4808:(a,b,c)=>{c.d(b,{U:()=>e,n:()=>d});class d{checkRateLimit(a,b={}){let c=b.maxRequests||100,d=b.windowMs||9e5,e=Date.now(),f=this.rateLimitMap.get(a);return!f||e>f.resetTime?(this.rateLimitMap.set(a,{count:1,resetTime:e+d}),!0):!(f.count>=c)&&(f.count++,!0)}validateInput(a,b){let c=[];for(let[d,e]of Object.entries(b)){let b=a[d];if(e.required&&(!b||""===b.toString().trim())){c.push(`${d} is required`);continue}if(b){if("string"===e.type){if("string"!=typeof b){c.push(`${d} must be a string`);continue}e.minLength&&b.length<e.minLength&&c.push(`${d} must be at least ${e.minLength} characters`),e.maxLength&&b.length>e.maxLength&&c.push(`${d} must be no more than ${e.maxLength} characters`),e.pattern&&!e.pattern.test(b)&&c.push(`${d} format is invalid`)}"email"===e.type&&(/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(b)||c.push(`${d} must be a valid email address`)),"phone"===e.type&&(/^[\+]?[1-9][\d]{0,15}$/.test(b.replace(/[\s\-\(\)]/g,""))||c.push(`${d} must be a valid phone number`))}}return{valid:0===c.length,errors:c}}sanitizeInput(a){let b={};for(let[c,d]of Object.entries(a))"string"==typeof d?b[c]=d.replace(/[<>]/g,"").replace(/javascript:/gi,"").replace(/on\w+=/gi,"").trim():b[c]=d;return b}validateApiKey(a,b){let c,d=null;if(a&&a.startsWith("Bearer ")?d=a.substring(7).trim():b&&(d=b.trim()),!d)return{valid:!1};let e=(c=new Set,process.env.DEFAULT_API_KEY&&c.add(process.env.DEFAULT_API_KEY),process.env.API_KEYS&&process.env.API_KEYS.split(",").forEach(a=>{let b=a.trim();b&&c.add(b)}),c).has(d);return e||console.log("‚ùå Invalid API key attempt"),{valid:e,apiKey:e?{key:d}:void 0}}addSecurityHeaders(a){if(a instanceof Response||a.headers){let b=new Headers(a.headers);return(b.set("X-Content-Type-Options","nosniff"),b.set("X-Frame-Options","DENY"),b.set("X-XSS-Protection","1; mode=block"),b.set("Content-Security-Policy","default-src 'self'"),a instanceof Response)?new Response(a.body,{status:a.status,statusText:a.statusText,headers:b}):(a.headers=b,a)}a.setHeader("X-Content-Type-Options","nosniff"),a.setHeader("X-Frame-Options","DENY"),a.setHeader("X-XSS-Protection","1; mode=block"),a.setHeader("Content-Security-Policy","default-src 'self'");try{a.removeHeader&&a.removeHeader("X-Powered-By")}catch{}return a}configureCORS(a,b=["*"]){let c=b.join(", ");a.setHeader("Access-Control-Allow-Origin",c),a.setHeader("Access-Control-Allow-Methods","GET, POST, OPTIONS"),a.setHeader("Access-Control-Allow-Headers","Content-Type, Authorization"),a.setHeader("Access-Control-Max-Age","86400")}logSecurityEvent(a,b,c){let d=new Date().toISOString();console.log(`[SECURITY] ${d} - ${a}`,{ip:c,userAgent:b.userAgent,endpoint:b.endpoint,...b})}secureRequestMiddleware(a={}){return async(b,c,d)=>{let e=b.headers["x-forwarded-for"]?.toString().split(",")[0]||b.headers["x-real-ip"]?.toString()||b.ip||"unknown",f=b.headers["user-agent"]||"unknown",g=b.method;if(a.allowedMethods&&!a.allowedMethods.includes(g)){this.logSecurityEvent("METHOD_NOT_ALLOWED",{method:g,endpoint:b.url},e),c.status(405).json({success:!1,error:"Method Not Allowed"});return}if(a.rateLimit&&!this.checkRateLimit(e,a.rateLimit)){this.logSecurityEvent("RATE_LIMIT_EXCEEDED",{endpoint:b.url,userAgent:f},e),c.status(429).setHeader("Retry-After","900").json({success:!1,error:"Too Many Requests"});return}if(a.requireAuth){let a=b.headers.authorization||"",d=b.headers["x-api-key"]||"",g=this.validateApiKey(a,d);if(!g.valid){this.logSecurityEvent("AUTH_FAILED",{endpoint:b.url,userAgent:f},e),c.status(401).json({success:!1,error:"Unauthorized",message:"Invalid or missing API key. Use Authorization: Bearer <key> or X-API-Key: <key> header"});return}b.apiKey=g.apiKey}if("POST"===g&&a.inputSchema){let d=this.sanitizeInput(b.body),g=this.validateInput(d,a.inputSchema);if(!g.valid){this.logSecurityEvent("VALIDATION_FAILED",{endpoint:b.url,errors:g.errors,userAgent:f},e),c.status(400).json({success:!1,error:"Validation Error",message:g.errors.join(", ")});return}b.body=d}this.addSecurityHeaders(c),this.configureCORS(c),d()}}async secureRequest(a,b={}){let{NextResponse:d}=await Promise.resolve().then(c.bind(c,5592));console.error("\uD83D\uDE80 secureRequest called:",{url:a.url,method:a.method,requireAuth:b.requireAuth,hasHeaders:!!a.headers});let e=a.headers.get("x-forwarded-for")||a.headers.get("x-real-ip")||"unknown",f=a.headers.get("user-agent")||"unknown",g=a.method;if(b.allowedMethods&&!b.allowedMethods.includes(g)){this.logSecurityEvent("METHOD_NOT_ALLOWED",{method:g,endpoint:a.url},e);let b=d.json({success:!1,error:"Method Not Allowed"},{status:405});return this.addSecurityHeaders(b),{allowed:!1,response:b}}if(b.rateLimit&&!this.checkRateLimit(e,b.rateLimit)){this.logSecurityEvent("RATE_LIMIT_EXCEEDED",{endpoint:a.url,userAgent:f},e);let b=d.json({success:!1,error:"Too Many Requests"},{status:429,headers:{"Retry-After":"900"}});return this.addSecurityHeaders(b),{allowed:!1,response:b}}if(b.requireAuth){let b=a.headers.get("authorization")||"",c=a.headers.get("x-api-key")||a.headers.get("X-API-Key")||"",g=Array.from(a.headers.entries()),h=g.filter(([a])=>a.toLowerCase().includes("api")||a.toLowerCase().includes("auth"));console.error("\uD83D\uDD10 Auth check:",JSON.stringify({hasAuthHeader:!!b,authHeaderPrefix:b.substring(0,20),hasXApiKey:!!c,xApiKeyPrefix:c.substring(0,20),xApiKeyFull:c,relevantHeaders:h,allHeaderKeys:g.map(([a])=>a)}));let i=this.validateApiKey(b,c);if(console.error("\uD83D\uDD10 Auth result:",JSON.stringify({valid:i.valid})),!i.valid){this.logSecurityEvent("AUTH_FAILED",{endpoint:a.url,userAgent:f},e);let b=d.json({success:!1,error:"Unauthorized",message:"Invalid or missing API key. Use Authorization: Bearer <key> or X-API-Key: <key> header"},{status:401});return this.addSecurityHeaders(b),{allowed:!1,response:b}}}let h=null;if("POST"===g&&b.inputSchema)try{let c=await a.json();h=this.sanitizeInput(c);let g=this.validateInput(h,b.inputSchema);if(!g.valid){this.logSecurityEvent("VALIDATION_FAILED",{endpoint:a.url,errors:g.errors,userAgent:f},e);let b=d.json({success:!1,error:"Validation Error",message:g.errors.join(", ")},{status:400});return this.addSecurityHeaders(b),{allowed:!1,response:b}}}catch(b){let a=d.json({success:!1,error:"Invalid JSON",message:"Request body must be valid JSON"},{status:400});return this.addSecurityHeaders(a),{allowed:!1,response:a}}return{allowed:!0,sanitizedData:h}}constructor(){this.rateLimitMap=new Map}}let e={scrapeRequest:{first_name:{type:"string",required:!0,minLength:1,maxLength:100},last_name:{type:"string",required:!0,minLength:1,maxLength:100},email:{type:"email",required:!0,maxLength:255},phone:{type:"phone",required:!0,minLength:10,maxLength:20}},adminLogin:{username:{type:"string",required:!0,minLength:3,maxLength:50},password:{type:"string",required:!0,minLength:8,maxLength:128}},apiKeyCreate:{name:{type:"string",required:!0,minLength:1,maxLength:100},description:{type:"string",required:!1,maxLength:500},customKey:{type:"string",required:!1,maxLength:200}}}},4870:a=>{a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6187:(a,b,c)=>{c.a(a,async(a,d)=>{try{c.r(b),c.d(b,{handler:()=>z,patchFetch:()=>y,routeModule:()=>A,serverHooks:()=>D,workAsyncStorage:()=>B,workUnitAsyncStorage:()=>C});var e=c(9225),f=c(4006),g=c(8317),h=c(9373),i=c(4775),j=c(8564),k=c(8575),l=c(261),m=c(4365),n=c(771),o=c(3461),p=c(7798),q=c(2280),r=c(2018),s=c(5696),t=c(7929),u=c(6439),v=c(7527),w=c(2284),x=a([w]);w=(x.then?(await x)():x)[0];let A=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/get-slots/route",pathname:"/api/get-slots",filename:"route",bundlePath:"app/api/get-slots/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"/Users/alisyed/Documents/chili-piper-scraper/src/app/api/get-slots/route.ts",nextConfigOutput:"standalone",userland:w}),{workAsyncStorage:B,workUnitAsyncStorage:C,serverHooks:D}=A;function y(){return(0,g.patchFetch)({workAsyncStorage:B,workUnitAsyncStorage:C})}async function z(a,b,c){A.isDev&&(0,h.addRequestMeta)(a,"devRequestTimingInternalsEnd",process.hrtime.bigint());let d="/api/get-slots/route";"/index"===d&&(d="/");let e=await A.prepare(a,b,{srcPage:d,multiZoneDraftMode:!1});if(!e)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:g,params:w,nextConfig:x,parsedUrl:y,isDraftMode:z,prerenderManifest:B,routerServerContext:C,isOnDemandRevalidate:D,revalidateOnlyGenerated:E,resolvedPathname:F,clientReferenceManifest:G,serverActionsManifest:H}=e,I=(0,l.normalizeAppPath)(d),J=!!(B.dynamicRoutes[I]||B.routes[F]),K=async()=>((null==C?void 0:C.render404)?await C.render404(a,b,y,!1):b.end("This page could not be found"),null);if(J&&!z){let a=!!B.routes[F],b=B.dynamicRoutes[I];if(b&&!1===b.fallback&&!a){if(x.experimental.adapterPath)return await K();throw new u.NoFallbackError}}let L=null;!J||A.isDev||z||(L=F,L="/index"===L?"/":L);let M=!0===A.isDev||!J,N=J&&!M;H&&G&&(0,j.setReferenceManifestsSingleton)({page:d,clientReferenceManifest:G,serverActionsManifest:H,serverModuleMap:(0,k.createServerModuleMap)({serverActionsManifest:H})});let O=a.method||"GET",P=(0,i.getTracer)(),Q=P.getActiveScopeSpan(),R={params:w,prerenderManifest:B,renderOpts:{experimental:{authInterrupts:!!x.experimental.authInterrupts},cacheComponents:!!x.cacheComponents,supportsDynamicResponse:M,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:x.cacheLife,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d)=>A.onRequestError(a,b,d,C)},sharedContext:{buildId:g}},S=new m.NodeNextRequest(a),T=new m.NodeNextResponse(b),U=n.NextRequestAdapter.fromNodeNextRequest(S,(0,n.signalFromNodeResponse)(b));try{let e=async a=>A.handle(U,R).finally(()=>{if(!a)return;a.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let c=P.getRootSpanAttributes();if(!c)return;if(c.get("next.span_type")!==o.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${c.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=c.get("next.route");if(e){let b=`${O} ${e}`;a.setAttributes({"next.route":e,"http.route":e,"next.span_name":b}),a.updateName(b)}else a.updateName(`${O} ${d}`)}),g=!!(0,h.getRequestMeta)(a,"minimalMode"),j=async h=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!g&&D&&E&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let d=await e(h);a.fetchMetrics=R.renderOpts.fetchMetrics;let i=R.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=R.renderOpts.collectedTags;if(!J)return await (0,q.I)(S,T,d,R.renderOpts.pendingWaitUntil),null;{let a=await d.blob(),b=(0,r.toNodeOutgoingHttpHeaders)(d.headers);j&&(b[t.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==R.renderOpts.collectedRevalidate&&!(R.renderOpts.collectedRevalidate>=t.INFINITE_CACHE)&&R.renderOpts.collectedRevalidate,e=void 0===R.renderOpts.collectedExpire||R.renderOpts.collectedExpire>=t.INFINITE_CACHE?void 0:R.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:d.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:e}}}}catch(b){throw(null==f?void 0:f.isStale)&&await A.onRequestError(a,b,{routerKind:"App Router",routePath:d,routeType:"route",revalidateReason:(0,p.c)({isStaticGeneration:N,isOnDemandRevalidate:D})},C),b}},l=await A.handleResponse({req:a,nextConfig:x,cacheKey:L,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:B,isRoutePPREnabled:!1,isOnDemandRevalidate:D,revalidateOnlyGenerated:E,responseGenerator:k,waitUntil:c.waitUntil,isMinimalMode:g});if(!J)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});g||b.setHeader("x-nextjs-cache",D?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),z&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,r.fromNodeOutgoingHttpHeaders)(l.value.headers);return g&&J||m.delete(t.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,s.getCacheControlHeader)(l.cacheControl)),await (0,q.I)(S,T,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};Q?await j(Q):await P.withPropagatedContext(a.headers,()=>P.trace(o.BaseServerSpan.handleRequest,{spanName:`${O} ${d}`,kind:i.SpanKind.SERVER,attributes:{"http.method":O,"http.target":a.url}},j))}catch(b){if(b instanceof u.NoFallbackError||await A.onRequestError(a,b,{routerKind:"App Router",routePath:I,routeType:"route",revalidateReason:(0,p.c)({isStaticGeneration:N,isOnDemandRevalidate:D})}),J)throw b;return await (0,q.I)(S,T,new Response(null,{status:500})),null}}d()}catch(a){d(a)}})},6439:a=>{a.exports=require("next/dist/shared/lib/no-fallback-error.external")},9294:a=>{a.exports=require("next/dist/server/app-render/work-async-storage.external.js")}};var b=require("../../../webpack-runtime.js");b.C(a);var c=b.X(0,[870,813,295],()=>b(b.s=6187));module.exports=c})();